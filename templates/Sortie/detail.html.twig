{% extends 'base.html.twig' %}

{% block title %}Détail de la sortie – {{ sortie.nom }}{% endblock %}



{% block body %}

    <div class="container mt-4">
        <a href="{{ path('sortie_list') }}" class="btn btn-link mb-3">Back to list</a>

        <div class="card shadow-sm">
            <div class="card-body">
                <h1 class="h4 mb-3">{{ sortie.nom }}</h1>

                <dl class="row mb-0">
                    <dt class="col-sm-4">Statut</dt>
                    <dd class="col-sm-8">

                        <span class="badge text-bg-secondary">{{ sortie.etat }}</span>
                    </dd>

                    <dt class="col-sm-4">Start</dt>
                    <dd class="col-sm-8">
                        {{ sortie.startDateTime ? sortie.startDateTime|date('d/m/Y H:i') : '—' }}
                    </dd>

                    <dt class="col-sm-4">Registration deadline</dt>
                    <dd class="col-sm-8">
                        {{ sortie.limitDate ? sortie.limitDate|date('d/m/Y H:i') : '—' }}
                    </dd>

                    <dt class="col-sm-4">Duration</dt>
                    <dd class="col-sm-8">
                        {{ sortie.duration ?? '—' }}
                    </dd>

                    <dt class="col-sm-4">Max capacity</dt>
                    <dd class="col-sm-8">
                        {{ sortie.nbRegistration ?? '—' }}
                    </dd>

                    <dt class="col-sm-4">Users ({{ sortie.users|length }})</dt>
                    <dd class="col-sm-8">
                        {% if sortie.users|length > 0 %}
                            <ul class="mb-0">

                                {% for p in sortie.users %}
                                    <li>
                                        <a href="{{ path('sortie_user_profil', {id: p.id}) }}">
                                            {{ p.prenom }} {{ p.nom }} ({{ p.email }})
                                        </a>
                                    </li>

                                {% endfor %}
                            </ul>
                        {% else %}
                            <span class="text-muted">Nothing yet</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-4">Infos</dt>
                    <dd class="col-sm-8">
                        {{ sortie.info ?: '—' }}
                    </dd>
                </dl>

                <hr class="my-4">

                {# --------- INSCRIPTION / DESISTEMENT --------- #}

                {# 1) Ouverture des inscriptions (utilise la constante passée par le contrôleur) #}
                {% set inscriptionsOuvertes = sortie.etat == ETAT_OU %}





                {# 2) Bouton S’INSCRIRE #}

                {% set can_register =
                    is_granted('ROLE_USER')
                    and inscriptionsOuvertes
                    and (sortie.limitDate is null or sortie.limitDate > date())
                    and (sortie.nbRegistration is null or sortie.users|length < sortie.nbRegistration)
                    and (not sortie.users.contains(app.user))
                %}

                {% if can_register %}
                    <form method="post" action="{{ path('sortie_inscrire', {id: sortie.id}) }}" class="d-inline">
                        <input type="hidden" name="_token" value="{{ csrf_token('inscrire' ~ sortie.id) }}">
                        <button class="btn btn-primary">Register</button>
                    </form>
                {% else %}
                    <div class="text-muted small">
                        {% if not is_granted('ROLE_USER') %}
                            Log in to register.
                        {% elseif not inscriptionsOuvertes %}
                            Registration is not open.
                        {% elseif sortie.limitDate is not null and sortie.limitDate <= date() %}
                            The registration deadline has passed.
                        {% elseif sortie.nbRegistration is not null and sortie.users|length >= sortie.nbRegistration %}
                            The outing is full.
                        {% elseif sortie.users.contains(app.user) %}
                            You are already registered.
                        {% endif %}
                    </div>
                {% endif %}

                {# 3) Bouton SE DÉSISTER (visible si inscrit et si la sortie n'a pas commencé) #}
                {% set can_withdraw =
                    is_granted('ROLE_USER')
                    and sortie.users.contains(app.user)
                    and (sortie.startDateTime is not null and sortie.startDateTime > date())
                %}

                {% if can_withdraw %}
                    <form method="post" action="{{ path('sortie_desister', {id: sortie.id}) }}" class="d-inline ms-2">
                        <input type="hidden" name="_token" value="{{ csrf_token('desister' ~ sortie.id) }}">
                        <button class="btn btn-warning" onclick="return confirm('Confirmer le désistement ?')">
                            Se désister
                        </button>
                    </form>
                {% else %}
                    {# Indices d'impossibilité de désistement #}
                    {% if is_granted('ROLE_USER') and sortie.users.contains(app.user) and sortie.startDateTime is not null and sortie.startDateTime <= date() %}
                        <div class="text-muted small mt-2">The event has already started. Withdrawal is no longer possible.</div>
                    {% endif %}
                {% endif %}
                {# --------------------------------------------- #}

            </div>
        </div>
    </div>
{% endblock %}
